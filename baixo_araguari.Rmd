---
title: "Baixo Araguari"
author: "Darren Norris"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 3
    number_sections: yes
    extra_dependencies: flafter
    highlight: tango
    includes:
      in_header: preamble.txe
  bookdown::html_document2:
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_caption: yes
urlcolor: blue
toc-title: Sumário
header-includes:
  - \counterwithin{figure}{section}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE, collapse = TRUE,
  comment = "#>" 
  )
def_hook <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  out <- def_hook(x, options)
  return(paste("\\begin{framed}\\begin{verbatim}", x, "\\end{verbatim}\\end{framed}", collapse = "\n"))
})
```

\newpage{}

# Apresentação

O objetivo é calcular métricas de paisagem, descrever a composição e 
a configuração da paisagem ao redor do Rio Araguari nos municípios de Macapá e Cutias.

As métricas da paisagem nos ajudam a entender as mudanças na paisagem de diferentes perspectivas (visual, ecológica, cultural). Asssim sendo, análises com métricas de paisagem é um atividade fundamental na ecologia da paisagem. Nesta exemplo (https://rpubs.com/darren75/baixo_araguari) aprenderemos sobre como analisar a cobertura da terra com métricas de paisagem em R.

# Área de estudo
Antigamente o Rio Araguari deságuava no oceano Atlântico, formando ondas que davam origem a Pororoca, utilizada para campeonatos de surfe. No entanto, atualmente, devido ao progressivo processo de erosão do Canal do Urucurituba, quase toda a água do rio é desviada para o rio Amazonas.  Portanto o Pororoca foi extinto, por causa do assoreamento na antiga foz do Rio Araguari.

Para visualizar um exemplo com as mudancas: https://earthengine.google.com/timelapse#v=1.07215,-50.49244,8.691,latLng&t=1.11&ps=50&bt=19840101&et=20201231&startDwell=0&endDwell=0

# Pacotes necessarios

```{r, message=FALSE, warning=FALSE}
library(landscapemetrics)
library(tidyverse)
library(sf)
library(raster)
library(terra)
library(tmap)
library(gridExtra)
library(kableExtra)
library(leafpop)
library(mapview)
library(mgcv)
library(readxl)
```


# Dados

## Dados: MapBiomas

Existem varios formas de importar e exportar dados geoespaciais.
Precisamos o arquivo com os dados de MapBiomas referente a região de estudo. 
Aqui vamos usar dados de 1985 "utm_cover_AP_muni_cutias_1985.tif" .

Link: [https://github.com/darrennorris/baixo-araguari/blob/main/data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1985.tif](https://github.com/darrennorris/baixo-araguari/blob/main/data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1985.tif){target="_blank"} 

Lembrando-se de salvar o arquivo ("utm_cover_AP_muni_cuitas_1985.tif") em um local conhecido no seu computador. Agora, nós podemos carregar os dados de cobertura da terra "utm_cover_AP_muni_cuitas_1985.tif" com a função <code>rast</code>.
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE}
# Selecionar e carregar arquivo "utm_cover_AP_muni_cuitas_1985.tif"
mapbiomas_1985 <- rast(file.choose())
# Selecionar e carregar arquivo "utm_cover_AP_muni_cuitas_2020.tif"
mapbiomas_2020 <- rast(file.choose())

```

```{r, echo=FALSE}
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1985.tif"
mapbiomas_1985 <- rast(rin)
mapbiomas_1985[mapbiomas_1985==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1988.tif"
mapbiomas_1988 <- rast(rin)
mapbiomas_1988[mapbiomas_1988==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1991.tif"
mapbiomas_1991 <- rast(rin)
mapbiomas_1991[mapbiomas_1991==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1994.tif"
mapbiomas_1994 <- rast(rin)
mapbiomas_1994[mapbiomas_1994==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_1997.tif"
mapbiomas_1997 <- rast(rin)
mapbiomas_1997[mapbiomas_1997==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2000.tif"
mapbiomas_2000 <- rast(rin)
mapbiomas_2000[mapbiomas_2000==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2003.tif"
mapbiomas_2003 <- rast(rin)
mapbiomas_2003[mapbiomas_2003==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2006.tif"
mapbiomas_2006 <- rast(rin)
mapbiomas_2006[mapbiomas_2006==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2009.tif"
mapbiomas_2009 <- rast(rin)
mapbiomas_2009[mapbiomas_2009==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2012.tif"
mapbiomas_2012 <- rast(rin)
mapbiomas_2012[mapbiomas_2012==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2015.tif"
mapbiomas_2015 <- rast(rin)
mapbiomas_2015[mapbiomas_2015==0] <- NA
rin <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2018.tif"
mapbiomas_2018 <- rast(rin)
mapbiomas_2018[mapbiomas_2018==0] <- NA
rin2020 <- "data/raster/AP_utm_muni_cutias/utm_cover_AP_muni_cutias_2020.tif"
mapbiomas_2020 <- rast(rin2020)
mapbiomas_2020[mapbiomas_2020==0] <- NA
```

```{r}
class_nomes <- read_excel("data/raster/AP_utm_muni_cutias/mapbiomas_6_legend.xlsx")
class_antropic <- class_nomes %>% 
  filter(type_class == "antropic") %>% pull(aid)

mapbiomas_1985_reclass <- mapbiomas_1985
mapbiomas_1985_reclass[mapbiomas_1985 %in% class_antropic] <- 18
mapbiomas_1988_reclass <- mapbiomas_1988
mapbiomas_1988_reclass[mapbiomas_1988 %in% class_antropic] <- 18
mapbiomas_1991_reclass <- mapbiomas_1991
mapbiomas_1991_reclass[mapbiomas_1991 %in% class_antropic] <- 18
mapbiomas_1994_reclass <- mapbiomas_1994
mapbiomas_1994_reclass[mapbiomas_1994 %in% class_antropic] <- 18
mapbiomas_1997_reclass <- mapbiomas_1997
mapbiomas_1997_reclass[mapbiomas_1997 %in% class_antropic] <- 18
mapbiomas_2000_reclass <- mapbiomas_2000
mapbiomas_2000_reclass[mapbiomas_2000 %in% class_antropic] <- 18
mapbiomas_2003_reclass <- mapbiomas_2003
mapbiomas_2003_reclass[mapbiomas_2003 %in% class_antropic] <- 18
mapbiomas_2006_reclass <- mapbiomas_2006
mapbiomas_2006_reclass[mapbiomas_2006 %in% class_antropic] <- 18
mapbiomas_2009_reclass <- mapbiomas_2009
mapbiomas_2009_reclass[mapbiomas_2009 %in% class_antropic] <- 18
mapbiomas_2012_reclass <- mapbiomas_2012
mapbiomas_2012_reclass[mapbiomas_2012 %in% class_antropic] <- 18
mapbiomas_2015_reclass <- mapbiomas_2015
mapbiomas_2015_reclass[mapbiomas_2015 %in% class_antropic] <- 18
mapbiomas_2018_reclass <- mapbiomas_2018
mapbiomas_2018_reclass[mapbiomas_2018 %in% class_antropic] <- 18
mapbiomas_2020_reclass <- mapbiomas_2020
mapbiomas_2020_reclass[mapbiomas_2020 %in% class_antropic] <- 18

res_pland<- calculate_lsm(mapbiomas_1985, what = "lsm_c_pland")
# 53.8 Campestre, 31.7 floresta, 8.5 agua, 2.5 pasto, 1.9 campo alagado
res_pland %>% 
  left_join(class_nomes, by = c("class" = "aid")) %>% 
  arrange(desc(value))
res_reclass_pland<- calculate_lsm(mapbiomas_1985_reclass, what = "lsm_c_pland")
# 53.8 Campestre, 31.7 floresta, 8.5 agua, 2.5 pasto, 1.9 campo alagado
res_reclass_pland %>% 
  left_join(class_nomes, by = c("class" = "aid")) %>% 
  arrange(desc(value))

# Plot
selvals <- which(is.finite(unique(values(mapbiomas_1985_reclass))))
class_vals <- unique(values(mapbiomas_1985_reclass))[selvals]
class_color <- class_nomes %>% 
  dplyr::filter(aid %in% class_vals) %>% dplyr::pull(hexadecimal_code)
class_color <- paste("#", class_color, sep="")
names(class_color) <-  class_nomes %>% filter(aid %in% class_vals) %>% pull(aid)
#labelas
my_label <- class_nomes %>% 
  dplyr::filter(aid %in% class_vals) %>% dplyr::pull(classe_descricao)
my_label <- ifelse(my_label=="Agricultura", "Antropico", my_label)
names(my_label) <- class_nomes %>% filter(aid %in% class_vals) %>% pull(aid)

tm_shape(mapbiomas_1985_reclass) +
  tm_raster(style = "cat", palette = class_color, labels = my_label, title="") + 
tm_scale_bar(breaks = c(0, 20, 40), text.size = 1, 
             position=c("right", "bottom")) +
tm_layout(legend.bg.color="white")

mapbiomas_1985_2020 <- c(mapbiomas_1985, mapbiomas_1988, mapbiomas_1991, 
                         mapbiomas_1994, mapbiomas_1997, mapbiomas_2000,
                        mapbiomas_2003,mapbiomas_2006, mapbiomas_2009, 
                        mapbiomas_2012, mapbiomas_2015, mapbiomas_2018,
                        mapbiomas_2020)
mapbiomas_1985_2020 <- classify(mapbiomas_1985_2020, cbind(0, NA))
reclass_m <- as.matrix(data.frame(human = class_antropic, new_value = 18))
mapbiomas_1985_2020 <- classify(mapbiomas_1985_2020, reclass_m)

mapbiomas_1985_2020_ag <- aggregate(mapbiomas_1985_2020, fact=5, fun="modal")
# Plot
vals85a20 <- c(unique(values(mapbiomas_1985_reclass)), 
               unique(values(mapbiomas_1991_reclass)), 
               unique(values(mapbiomas_1997_reclass)), 
               unique(values(mapbiomas_2003_reclass)), 
               unique(values(mapbiomas_2009_reclass)), 
               unique(values(mapbiomas_2015_reclass)), 
               unique(values(mapbiomas_2020_reclass)))
class_vals <- unique(vals85a20[is.finite(vals85a20)])
class_color <- class_nomes %>% 
  dplyr::filter(aid %in% class_vals) %>% dplyr::pull(hexadecimal_code)
class_color <- paste("#", class_color, sep="")
names(class_color) <-  class_nomes %>% filter(aid %in% class_vals) %>% pull(aid)
#labelas
my_label <- class_nomes %>% 
  dplyr::filter(aid %in% class_vals) %>% dplyr::pull(classe_descricao)
my_label <- ifelse(my_label=="Agricultura", "Antropico", my_label)
names(my_label) <- class_nomes %>% filter(aid %in% class_vals) %>% pull(aid)
tm_shape(mapbiomas_1985_2020) + 
   tm_raster(style = "cat", 
             palette = class_color, labels = my_label, title="")  +
  tm_facets(ncol=2) + 
#tm_scale_bar(breaks = c(0, 20, 40), text.size = 1, 
#             position=c("right", "bottom")) +
tm_layout(legend.bg.color="white", 
          legend.outside = TRUE,
            legend.outside.position = "right")
```


```{r}
# zoom in
my_bb <- st_read("data/vector/AP_muni_Macapa_Cutias_clipbuff2km.shp") %>% 
  st_bbox()
my_bb[1] <- 553378
# animation
tm_ani <- tm_shape(mapbiomas_1985_2020_ag, bbox = my_bb) + 
   tm_raster(style = "cat", 
             palette = class_color, legend.show =FALSE)  +
  tm_facets(ncol=1, nrow=1) 

tmap_animation(tm_ani, delay=100, filename = "baixo_araguari.gif")
```

